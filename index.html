<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Travel Photo Map</title>
    <link rel="stylesheet" href="css/leaflet.css">
    <link rel="stylesheet" href="css/MarkerCluster.css">
    <link rel="stylesheet" href="css/MarkerCluster.Default.css">
    <link rel="stylesheet" href="css/Leaflet.Photo.css">
    <link rel="stylesheet" href="css/map.css">
</head>
<body>
    <div id="map"></div>

    <script src="js/leaflet.js"></script>
    <script src="js/leaflet.markercluster.js"></script>
    <script src="js/Leaflet.Photo.js"></script>
    <script>
        (function () {
            var map = L.map('map').setView([20, 0], 2);

            var osmAttr = '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors';
            var cartoAttr = osmAttr + ', &copy; <a href="https://carto.com/attributions">CARTO</a>';

            var streetMap = L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: osmAttr,
                maxZoom: 19
            });

            var humanitarian = L.tileLayer('https://{s}.tile.openstreetmap.fr/hot/{z}/{x}/{y}.png', {
                attribution: osmAttr + ', Tiles by <a href="https://www.hotosm.org/">HOT</a> hosted by <a href="https://openstreetmap.fr/">OSM France</a>',
                maxZoom: 19
            });

            var terrain = L.tileLayer('https://{s}.tile.opentopomap.org/{z}/{x}/{y}.png', {
                attribution: 'Map data: ' + osmAttr + ', <a href="http://viewfinderpanoramas.org">SRTM</a> | Map style: &copy; <a href="https://opentopomap.org">OpenTopoMap</a>',
                maxZoom: 17
            });

            var satellite = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
                attribution: 'Tiles &copy; Esri &mdash; Source: Esri, i-cubed, USDA, USGS, AEX, GeoEye, Getmapping, Aerogrid, IGN, IGP, UPR-EGP, and the GIS User Community',
                maxZoom: 18
            });

            var esriStreet = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Street_Map/MapServer/tile/{z}/{y}/{x}', {
                attribution: 'Tiles &copy; Esri &mdash; Source: Esri, DeLorme, NAVTEQ, USGS, Intermap, iPC, NRCAN, Esri Japan, METI, TomTom',
                maxZoom: 18
            });

            var positron = L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}.png', {
                attribution: cartoAttr,
                maxZoom: 20,
                subdomains: 'abcd'
            });

            var darkMatter = L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}.png', {
                attribution: cartoAttr,
                maxZoom: 20,
                subdomains: 'abcd'
            });

            var voyager = L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}.png', {
                attribution: cartoAttr,
                maxZoom: 20,
                subdomains: 'abcd'
            });

            var usgsTopo = L.tileLayer('https://basemap.nationalmap.gov/arcgis/rest/services/USGSTopo/MapServer/tile/{z}/{y}/{x}', {
                attribution: 'Tiles courtesy of the <a href="https://usgs.gov/">U.S. Geological Survey</a>',
                maxZoom: 20
            });

            var usgsImagery = L.tileLayer('https://basemap.nationalmap.gov/arcgis/rest/services/USGSImageryOnly/MapServer/tile/{z}/{y}/{x}', {
                attribution: 'Tiles courtesy of the <a href="https://usgs.gov/">U.S. Geological Survey</a>',
                maxZoom: 20
            });

            streetMap.addTo(map);

            var baseLayers = {
                'Street Map': streetMap,
                'Humanitarian': humanitarian,
                'Terrain': terrain,
                'Satellite (Esri)': satellite,
                'Esri Street': esriStreet,
                'CartoDB Positron': positron,
                'CartoDB Dark Matter': darkMatter,
                'CartoDB Voyager': voyager,
                'USGS Topo': usgsTopo,
                'USGS Imagery': usgsImagery
            };
            var overlayLayers = {};
            var layerControl = L.control.layers(baseLayers, overlayLayers).addTo(map);

            function buildPopupHTML(photo) {
                var html = '<div class="photo-popup">';
                if (photo.type === 'video') {
                    html += '<video controls preload="metadata"><source src="' + photo.url + '"></video>';
                } else {
                    html += '<img src="' + photo.thumbnail + '" alt="' + (photo.caption || 'Photo') + '">';
                }
                if (photo.google_photos_url) {
                    html += '<a href="' + photo.google_photos_url + '" target="_blank" rel="noopener noreferrer" class="photo-link">View on Google Photos</a>';
                }
                html += '<div class="popup-info">';
                if (photo.caption) {
                    html += '<p class="popup-caption">' + photo.caption + '</p>';
                }
                if (photo.date) {
                    html += '<p class="popup-date">' + photo.date + '</p>';
                }
                if (photo.tags && photo.tags.length > 0) {
                    html += '<div class="popup-tags">';
                    for (var i = 0; i < photo.tags.length; i++) {
                        html += '<span class="popup-tag">' + photo.tags[i] + '</span>';
                    }
                    html += '</div>';
                }
                html += '</div></div>';
                return html;
            }

            function showEmptyState() {
                var el = document.createElement('div');
                el.className = 'empty-state';
                el.innerHTML = '<h2>No Photos Yet</h2><p>Add geotagged photos to the <code>photos/</code> folder<br>and run <code>python scripts/process_photos.py</code></p>';
                document.body.appendChild(el);
            }

            // Hoisted state for slider rebuilds
            var photoLayer = null;
            var allPhotos = [];
            var filteredPhotos = [];
            var currentClusterRadius = 30;
            var currentIconSize = 90;
            var cityClusters = [];

            var lightboxIndex = -1;
            var lightboxOverlay = null;

            function openLightbox(index) {
                if (filteredPhotos.length === 0) return;
                if (index < 0) index = 0;
                if (index >= filteredPhotos.length) index = filteredPhotos.length - 1;
                lightboxIndex = index;
                var photo = filteredPhotos[index];

                if (!lightboxOverlay) {
                    lightboxOverlay = document.createElement('div');
                    lightboxOverlay.className = 'lightbox-overlay';
                    lightboxOverlay.innerHTML =
                        '<button class="lightbox-close">&times;</button>' +
                        '<button class="lightbox-nav lightbox-prev">&#8249;</button>' +
                        '<div class="lightbox-media"></div>' +
                        '<button class="lightbox-nav lightbox-next">&#8250;</button>' +
                        '<div class="lightbox-info">' +
                            '<p class="lightbox-caption"></p>' +
                            '<p class="lightbox-date"></p>' +
                            '<div class="lightbox-tags"></div>' +
                            '<a class="lightbox-link" target="_blank" rel="noopener noreferrer">View on Google Photos</a>' +
                        '</div>';
                    document.body.appendChild(lightboxOverlay);

                    lightboxOverlay.querySelector('.lightbox-close').addEventListener('click', function (evt) {
                        evt.stopPropagation();
                        closeLightbox();
                    });
                    lightboxOverlay.querySelector('.lightbox-prev').addEventListener('click', function (evt) {
                        evt.stopPropagation();
                        openLightbox(lightboxIndex - 1);
                    });
                    lightboxOverlay.querySelector('.lightbox-next').addEventListener('click', function (evt) {
                        evt.stopPropagation();
                        openLightbox(lightboxIndex + 1);
                    });
                    lightboxOverlay.addEventListener('click', function (evt) {
                        if (evt.target === lightboxOverlay) closeLightbox();
                    });
                }

                // Populate media
                var mediaContainer = lightboxOverlay.querySelector('.lightbox-media');
                if (photo.type === 'video') {
                    mediaContainer.innerHTML = '<video controls autoplay><source src="' + photo.url + '"></video>';
                } else {
                    // Progressive loading: show thumbnail immediately, swap to high-res when loaded
                    var img = document.createElement('img');
                    img.src = photo.thumbnail;
                    img.alt = photo.caption || 'Photo';
                    img.className = 'lightbox-img loading';
                    mediaContainer.innerHTML = '';
                    mediaContainer.appendChild(img);

                    if (photo.web_url) {
                        var hiRes = new Image();
                        hiRes.onload = function () {
                            if (img.parentNode) {
                                img.src = hiRes.src;
                                img.classList.remove('loading');
                            }
                        };
                        hiRes.onerror = function () {
                            img.classList.remove('loading');
                        };
                        hiRes.src = photo.web_url;
                    } else {
                        img.classList.remove('loading');
                    }
                }

                // Populate info
                var captionEl = lightboxOverlay.querySelector('.lightbox-caption');
                captionEl.textContent = photo.caption || '';
                captionEl.style.display = photo.caption ? '' : 'none';

                var dateEl = lightboxOverlay.querySelector('.lightbox-date');
                dateEl.textContent = photo.date || '';
                dateEl.style.display = photo.date ? '' : 'none';

                var tagsEl = lightboxOverlay.querySelector('.lightbox-tags');
                if (photo.tags && photo.tags.length > 0) {
                    var tagsHtml = '';
                    for (var t = 0; t < photo.tags.length; t++) {
                        tagsHtml += '<span class="lightbox-tag">' + photo.tags[t] + '</span>';
                    }
                    tagsEl.innerHTML = tagsHtml;
                    tagsEl.style.display = '';
                } else {
                    tagsEl.innerHTML = '';
                    tagsEl.style.display = 'none';
                }

                var linkEl = lightboxOverlay.querySelector('.lightbox-link');
                if (photo.google_photos_url) {
                    linkEl.href = photo.google_photos_url;
                    linkEl.style.display = '';
                } else {
                    linkEl.style.display = 'none';
                }

                // Arrow visibility
                lightboxOverlay.querySelector('.lightbox-prev').style.display = index <= 0 ? 'none' : '';
                lightboxOverlay.querySelector('.lightbox-next').style.display = index >= filteredPhotos.length - 1 ? 'none' : '';

                lightboxOverlay.style.display = 'flex';

                // Preload adjacent high-res images (fall back to thumbnail if no web_url)
                if (index > 0 && filteredPhotos[index - 1].type !== 'video') {
                    new Image().src = filteredPhotos[index - 1].web_url || filteredPhotos[index - 1].thumbnail;
                }
                if (index < filteredPhotos.length - 1 && filteredPhotos[index + 1].type !== 'video') {
                    new Image().src = filteredPhotos[index + 1].web_url || filteredPhotos[index + 1].thumbnail;
                }
            }

            function closeLightbox() {
                if (lightboxOverlay) lightboxOverlay.style.display = 'none';
                lightboxIndex = -1;
            }

            document.addEventListener('keydown', function (evt) {
                if (lightboxIndex < 0) return;
                if (evt.key === 'Escape') closeLightbox();
                else if (evt.key === 'ArrowLeft') openLightbox(lightboxIndex - 1);
                else if (evt.key === 'ArrowRight') openLightbox(lightboxIndex + 1);
            });

            function onPhotoClick(e) {
                var photo = e.layer.photo;
                var index = -1;
                for (var i = 0; i < filteredPhotos.length; i++) {
                    if (filteredPhotos[i].url === photo.url && filteredPhotos[i].lat === photo.lat && filteredPhotos[i].lng === photo.lng) {
                        index = i;
                        break;
                    }
                }
                if (index >= 0) {
                    openLightbox(index);
                }
            }

            function rebuildPhotoLayer(photos) {
                var data = photos || filteredPhotos;
                if (photoLayer) {
                    photoLayer.off('click', onPhotoClick);
                    map.removeLayer(photoLayer);
                }
                photoLayer = L.photo.cluster({
                    maxClusterRadius: currentClusterRadius,
                    spiderfyDistanceMultiplier: 2,
                    iconSize: [currentIconSize, currentIconSize]
                });
                photoLayer.on('click', onPhotoClick);
                photoLayer.add(data).addTo(map);
            }

            // Load annotations (graceful failure if missing)
            fetch('data/annotations.json')
                .then(function (response) {
                    if (!response.ok) return [];
                    return response.json();
                })
                .then(function (annotations) {
                    if (!annotations || annotations.length === 0) return;
                    for (var i = 0; i < annotations.length; i++) {
                        var ann = annotations[i];
                        var icon = L.divIcon({
                            className: 'annotation-marker',
                            html: '<span class="annotation-pin">&#128204;</span>',
                            iconSize: [28, 28],
                            iconAnchor: [14, 28]
                        });
                        var marker = L.marker([ann.lat, ann.lng], { icon: icon });
                        var popupHTML = '<div class="annotation-popup">';
                        if (ann.title) popupHTML += '<strong>' + ann.title + '</strong>';
                        if (ann.date) popupHTML += '<br><span class="annotation-date">' + ann.date + '</span>';
                        if (ann.text) popupHTML += '<p>' + ann.text + '</p>';
                        popupHTML += '</div>';
                        marker.bindPopup(popupHTML);
                        marker.addTo(map);
                    }
                })
                .catch(function () {
                    // annotations.json missing is fine
                });

            // Load timeline overlay (graceful failure if missing)
            var activityColors = {
                'WALKING': '#4CAF50',
                'RUNNING': '#8BC34A',
                'CYCLING': '#FF9800',
                'DRIVING': '#2196F3',
                'TRANSIT': '#9C27B0',
                'FLYING': '#F44336',
                'SKIING': '#00BCD4',
                'SAILING': '#3F51B5',
                'UNKNOWN': '#9E9E9E'
            };

            function formatDuration(startStr, endStr) {
                if (!startStr || !endStr) return '';
                try {
                    var start = new Date(startStr);
                    var end = new Date(endStr);
                    var mins = Math.round((end - start) / 60000);
                    if (mins < 60) return mins + ' min';
                    var hours = Math.floor(mins / 60);
                    var remMins = mins % 60;
                    return hours + 'h ' + (remMins > 0 ? remMins + 'm' : '');
                } catch (e) {
                    return '';
                }
            }

            function formatTime(isoStr) {
                if (!isoStr) return '';
                try {
                    var d = new Date(isoStr);
                    return d.toLocaleDateString() + ' ' + d.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                } catch (e) {
                    return '';
                }
            }

            fetch('data/timeline.json')
                .then(function (response) {
                    if (!response.ok) return null;
                    return response.json();
                })
                .then(function (timeline) {
                    if (!timeline) return;

                    var pathsGroup = L.layerGroup();
                    var placesGroup = L.layerGroup();

                    // Render activity segments as colored polylines
                    var segments = timeline.segments || [];
                    for (var i = 0; i < segments.length; i++) {
                        var seg = segments[i];
                        if (!seg.points || seg.points.length < 2) continue;

                        var color = activityColors[seg.activity] || activityColors['UNKNOWN'];
                        var polyline = L.polyline(seg.points, {
                            color: color,
                            weight: 3,
                            opacity: 0.7
                        });

                        var popupHtml = '<div class="timeline-popup">';
                        popupHtml += '<strong>' + (seg.activity || 'Unknown') + '</strong>';
                        var dur = formatDuration(seg.start, seg.end);
                        if (dur) popupHtml += '<br><span class="timeline-duration">' + dur + '</span>';
                        if (seg.start) popupHtml += '<br><span class="timeline-time">' + formatTime(seg.start) + '</span>';
                        popupHtml += '</div>';
                        polyline.bindPopup(popupHtml);

                        pathsGroup.addLayer(polyline);
                    }

                    // Render place visits as circle markers
                    var places = timeline.places || [];
                    for (var j = 0; j < places.length; j++) {
                        var place = places[j];
                        if (place.lat == null || place.lng == null) continue;

                        var circle = L.circleMarker([place.lat, place.lng], {
                            radius: 6,
                            fillColor: '#E91E63',
                            color: '#C2185B',
                            weight: 2,
                            opacity: 0.9,
                            fillOpacity: 0.7
                        });

                        var placeHtml = '<div class="timeline-popup">';
                        if (place.name) placeHtml += '<strong>' + place.name + '</strong>';
                        if (place.address) placeHtml += '<br><span class="timeline-address">' + place.address + '</span>';
                        var placeDur = formatDuration(place.start, place.end);
                        if (placeDur) placeHtml += '<br><span class="timeline-duration">' + placeDur + '</span>';
                        if (place.start) placeHtml += '<br><span class="timeline-time">' + formatTime(place.start) + '</span>';
                        placeHtml += '</div>';
                        circle.bindPopup(placeHtml);

                        placesGroup.addLayer(circle);
                    }

                    // Add overlays to layer control
                    if (pathsGroup.getLayers().length > 0) {
                        layerControl.addOverlay(pathsGroup, 'Travel Paths');
                        pathsGroup.addTo(map);
                    }
                    if (placesGroup.getLayers().length > 0) {
                        layerControl.addOverlay(placesGroup, 'Visited Places');
                        placesGroup.addTo(map);
                    }
                })
                .catch(function () {
                    // timeline.json missing is fine
                });

            function haversineKm(lat1, lng1, lat2, lng2) {
                var R = 6371;
                var dLat = (lat2 - lat1) * Math.PI / 180;
                var dLng = (lng2 - lng1) * Math.PI / 180;
                var a = Math.sin(dLat / 2) * Math.sin(dLat / 2) +
                    Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                    Math.sin(dLng / 2) * Math.sin(dLng / 2);
                return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
            }

            function clusterPhotosIntoCities(photos) {
                var sorted = photos.slice().sort(function (a, b) {
                    return (a.date || '').localeCompare(b.date || '');
                });

                var clusters = [];
                for (var i = 0; i < sorted.length; i++) {
                    var p = sorted[i];
                    if (clusters.length === 0) {
                        clusters.push({ photos: [p], centroidLat: p.lat, centroidLng: p.lng });
                    } else {
                        var cur = clusters[clusters.length - 1];
                        var dist = haversineKm(cur.centroidLat, cur.centroidLng, p.lat, p.lng);
                        if (dist > 50) {
                            clusters.push({ photos: [p], centroidLat: p.lat, centroidLng: p.lng });
                        } else {
                            cur.photos.push(p);
                            var n = cur.photos.length;
                            cur.centroidLat = cur.centroidLat + (p.lat - cur.centroidLat) / n;
                            cur.centroidLng = cur.centroidLng + (p.lng - cur.centroidLng) / n;
                        }
                    }
                }

                var knownCities = [
                    { name: 'London', lat: 51.5074, lng: -0.1278 },
                    { name: 'Copenhagen', lat: 55.6761, lng: 12.5683 },
                    { name: 'Hamburg', lat: 53.5511, lng: 9.9937 },
                    { name: 'Heidelberg', lat: 49.3988, lng: 8.6724 },
                    { name: 'Munich', lat: 48.1351, lng: 11.5820 },
                    { name: 'Prague', lat: 50.0755, lng: 14.4378 }
                ];
                var palette = ['#E53935', '#1E88E5', '#43A047', '#FB8C00', '#8E24AA', '#00ACC1'];

                for (var c = 0; c < clusters.length; c++) {
                    var cl = clusters[c];
                    var bestCity = null;
                    var bestDist = Infinity;
                    for (var k = 0; k < knownCities.length; k++) {
                        var d = haversineKm(cl.centroidLat, cl.centroidLng, knownCities[k].lat, knownCities[k].lng);
                        if (d < bestDist) {
                            bestDist = d;
                            bestCity = knownCities[k];
                        }
                    }
                    cl.cityName = bestDist <= 80 ? bestCity.name : 'Unknown';
                    cl.color = palette[c % palette.length];

                    var dates = cl.photos.map(function (p) { return p.date || ''; }).filter(function (d) { return d; }).sort();
                    cl.startDate = dates[0] || '';
                    cl.endDate = dates[dates.length - 1] || '';

                    for (var j = 0; j < cl.photos.length; j++) {
                        cl.photos[j].cityIndex = c;
                        cl.photos[j].cityName = cl.cityName;
                        cl.photos[j].cityColor = cl.color;
                    }
                }

                return clusters;
            }

            function formatDateShort(isoDate) {
                if (!isoDate) return '';
                var months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
                var parts = isoDate.split('-');
                if (parts.length < 3) return isoDate;
                return months[parseInt(parts[1], 10) - 1] + ' ' + parseInt(parts[2], 10);
            }

            fetch('data/manifest.json')
                .then(function (response) {
                    if (!response.ok) throw new Error('Failed to load manifest');
                    return response.json();
                })
                .then(function (photos) {
                    if (!photos || photos.length === 0) {
                        showEmptyState();
                        return;
                    }

                    allPhotos = photos;
                    cityClusters = clusterPhotosIntoCities(allPhotos);
                    filteredPhotos = allPhotos;
                    rebuildPhotoLayer();

                    // Build unique sorted dates
                    var dateSet = {};
                    for (var i = 0; i < allPhotos.length; i++) {
                        if (allPhotos[i].date) dateSet[allPhotos[i].date] = true;
                    }
                    var uniqueDates = Object.keys(dateSet).sort();

                    // Build timeline segments: assign each date to the cluster with the most photos on that date
                    var dateClusterMap = {};
                    for (var di = 0; di < uniqueDates.length; di++) {
                        var dStr = uniqueDates[di];
                        var countPerCluster = {};
                        for (var pi = 0; pi < allPhotos.length; pi++) {
                            if (allPhotos[pi].date === dStr && allPhotos[pi].cityIndex !== undefined) {
                                var ci = allPhotos[pi].cityIndex;
                                countPerCluster[ci] = (countPerCluster[ci] || 0) + 1;
                            }
                        }
                        var bestCluster = 0;
                        var bestCount = 0;
                        for (var key in countPerCluster) {
                            if (countPerCluster[key] > bestCount) {
                                bestCount = countPerCluster[key];
                                bestCluster = parseInt(key, 10);
                            }
                        }
                        dateClusterMap[dStr] = bestCluster;
                    }

                    // Build contiguous runs for timeline segments
                    var timelineSegments = [];
                    if (uniqueDates.length > 0) {
                        var runStart = 0;
                        var runCluster = dateClusterMap[uniqueDates[0]];
                        for (var ri = 1; ri <= uniqueDates.length; ri++) {
                            var curCluster = ri < uniqueDates.length ? dateClusterMap[uniqueDates[ri]] : -1;
                            if (curCluster !== runCluster) {
                                timelineSegments.push({
                                    clusterIndex: runCluster,
                                    startIdx: runStart,
                                    count: ri - runStart,
                                    color: cityClusters[runCluster] ? cityClusters[runCluster].color : '#999',
                                    cityName: cityClusters[runCluster] ? cityClusters[runCluster].cityName : 'Unknown'
                                });
                                runStart = ri;
                                runCluster = curCluster;
                            }
                        }
                    }

                    // Unified control
                    var UnifiedControl = L.Control.extend({
                        options: { position: 'bottomleft' },
                        onAdd: function () {
                            var container = L.DomUtil.create('div', 'unified-control');
                            L.DomEvent.disableClickPropagation(container);
                            L.DomEvent.disableScrollPropagation(container);

                            var totalDates = uniqueDates.length || 1;

                            // Build timeline track segments HTML
                            var segmentsHtml = '';
                            for (var s = 0; s < timelineSegments.length; s++) {
                                var seg = timelineSegments[s];
                                var leftPct = (seg.startIdx / totalDates * 100).toFixed(2);
                                var widthPct = (seg.count / totalDates * 100).toFixed(2);
                                var labelStyle = parseFloat(widthPct) < 8 ? ' style="display:none"' : '';
                                segmentsHtml += '<div class="timeline-segment" style="--seg-offset:' + leftPct + '%;--seg-size:' + widthPct + '%;background:' + seg.color + '">' +
                                    '<span class="segment-label"' + labelStyle + '>' + seg.cityName + '</span></div>';
                            }

                            var maxIdx = uniqueDates.length > 0 ? uniqueDates.length - 1 : 0;
                            var startLabel = uniqueDates.length > 0 ? formatDateShort(uniqueDates[0]) : '';
                            var endLabel = uniqueDates.length > 0 ? formatDateShort(uniqueDates[maxIdx]) : '';

                            container.innerHTML =
                                '<div class="timeline-bar">' +
                                    '<div class="timeline-track">' + segmentsHtml + '</div>' +
                                    '<input type="range" class="timeline-handle timeline-handle-min" min="0" max="' + maxIdx + '" value="0">' +
                                    '<input type="range" class="timeline-handle timeline-handle-max" min="0" max="' + maxIdx + '" value="' + maxIdx + '">' +
                                    '<div class="timeline-date-display">' +
                                        '<span class="timeline-date-start">' + startLabel + '</span>' +
                                        '<span class="timeline-date-end">' + endLabel + '</span>' +
                                    '</div>' +
                                '</div>' +
                                '<details class="settings-section">' +
                                    '<summary>Settings</summary>' +
                                    '<label>Cluster Radius <span class="slider-value" id="cluster-val">' + currentClusterRadius + '</span></label>' +
                                    '<input type="range" id="cluster-slider" min="10" max="100" value="' + currentClusterRadius + '">' +
                                    '<label>Photo Size <span class="slider-value" id="size-val">' + currentIconSize + 'px</span></label>' +
                                    '<input type="range" id="size-slider" min="45" max="180" value="' + currentIconSize + '">' +
                                '</details>';

                            return container;
                        }
                    });
                    new UnifiedControl().addTo(map);

                    // Timeline slider handlers
                    var handleMin = document.querySelector('.timeline-handle-min');
                    var handleMax = document.querySelector('.timeline-handle-max');
                    var dateStartLabel = document.querySelector('.timeline-date-start');
                    var dateEndLabel = document.querySelector('.timeline-date-end');

                    function onTimelineChange() {
                        var minIdx = parseInt(handleMin.value, 10);
                        var maxIdx = parseInt(handleMax.value, 10);
                        if (minIdx > maxIdx) {
                            if (this === handleMin) { handleMin.value = maxIdx; minIdx = maxIdx; }
                            else { handleMax.value = minIdx; maxIdx = minIdx; }
                        }

                        dateStartLabel.textContent = formatDateShort(uniqueDates[minIdx]);
                        dateEndLabel.textContent = formatDateShort(uniqueDates[maxIdx]);

                        var minDate = uniqueDates[minIdx];
                        var maxDate = uniqueDates[maxIdx];
                        filteredPhotos = [];
                        for (var f = 0; f < allPhotos.length; f++) {
                            var pd = allPhotos[f].date || '';
                            if (pd >= minDate && pd <= maxDate) {
                                filteredPhotos.push(allPhotos[f]);
                            }
                        }

                        rebuildPhotoLayer();
                        try {
                            map.fitBounds(photoLayer.getBounds(), { padding: [50, 50] });
                        } catch (e) {}
                    }

                    if (handleMin && handleMax) {
                        handleMin.addEventListener('input', onTimelineChange);
                        handleMax.addEventListener('input', onTimelineChange);
                    }

                    // Settings slider handlers
                    document.getElementById('cluster-slider').addEventListener('input', function () {
                        currentClusterRadius = parseInt(this.value, 10);
                        document.getElementById('cluster-val').textContent = currentClusterRadius;
                        if (filteredPhotos.length > 0) rebuildPhotoLayer();
                    });

                    document.getElementById('size-slider').addEventListener('input', function () {
                        currentIconSize = parseInt(this.value, 10);
                        document.getElementById('size-val').textContent = currentIconSize + 'px';
                        if (filteredPhotos.length > 0) rebuildPhotoLayer();
                    });

                    try {
                        map.fitBounds(photoLayer.getBounds(), { padding: [50, 50] });
                    } catch (e) {
                        // getBounds can fail if all markers are at the same point
                    }
                })
                .catch(function (err) {
                    console.error('Error loading photo manifest:', err);
                    showEmptyState();
                });
        })();
    </script>
</body>
</html>
