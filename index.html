<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Travel Photo Map</title>
    <link rel="stylesheet" href="css/leaflet.css">
    <link rel="stylesheet" href="css/MarkerCluster.css">
    <link rel="stylesheet" href="css/MarkerCluster.Default.css">
    <link rel="stylesheet" href="css/Leaflet.Photo.css">
    <link rel="stylesheet" href="css/map.css">
</head>
<body>
    <div id="map"></div>

    <script src="js/leaflet.js"></script>
    <script src="js/leaflet.markercluster.js"></script>
    <script src="js/Leaflet.Photo.js"></script>
    <script>
        (function () {
            var map = L.map('map').setView([20, 0], 2);

            var osmAttr = '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors';
            var cartoAttr = osmAttr + ', &copy; <a href="https://carto.com/attributions">CARTO</a>';

            var streetMap = L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: osmAttr,
                maxZoom: 19
            });

            var humanitarian = L.tileLayer('https://{s}.tile.openstreetmap.fr/hot/{z}/{x}/{y}.png', {
                attribution: osmAttr + ', Tiles by <a href="https://www.hotosm.org/">HOT</a> hosted by <a href="https://openstreetmap.fr/">OSM France</a>',
                maxZoom: 19
            });

            var terrain = L.tileLayer('https://{s}.tile.opentopomap.org/{z}/{x}/{y}.png', {
                attribution: 'Map data: ' + osmAttr + ', <a href="http://viewfinderpanoramas.org">SRTM</a> | Map style: &copy; <a href="https://opentopomap.org">OpenTopoMap</a>',
                maxZoom: 17
            });

            var satellite = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
                attribution: 'Tiles &copy; Esri &mdash; Source: Esri, i-cubed, USDA, USGS, AEX, GeoEye, Getmapping, Aerogrid, IGN, IGP, UPR-EGP, and the GIS User Community',
                maxZoom: 18
            });

            var esriStreet = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Street_Map/MapServer/tile/{z}/{y}/{x}', {
                attribution: 'Tiles &copy; Esri &mdash; Source: Esri, DeLorme, NAVTEQ, USGS, Intermap, iPC, NRCAN, Esri Japan, METI, TomTom',
                maxZoom: 18
            });

            var positron = L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}.png', {
                attribution: cartoAttr,
                maxZoom: 20,
                subdomains: 'abcd'
            });

            var darkMatter = L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}.png', {
                attribution: cartoAttr,
                maxZoom: 20,
                subdomains: 'abcd'
            });

            var voyager = L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}.png', {
                attribution: cartoAttr,
                maxZoom: 20,
                subdomains: 'abcd'
            });

            var usgsTopo = L.tileLayer('https://basemap.nationalmap.gov/arcgis/rest/services/USGSTopo/MapServer/tile/{z}/{y}/{x}', {
                attribution: 'Tiles courtesy of the <a href="https://usgs.gov/">U.S. Geological Survey</a>',
                maxZoom: 20
            });

            var usgsImagery = L.tileLayer('https://basemap.nationalmap.gov/arcgis/rest/services/USGSImageryOnly/MapServer/tile/{z}/{y}/{x}', {
                attribution: 'Tiles courtesy of the <a href="https://usgs.gov/">U.S. Geological Survey</a>',
                maxZoom: 20
            });

            streetMap.addTo(map);

            L.control.layers({
                'Street Map': streetMap,
                'Humanitarian': humanitarian,
                'Terrain': terrain,
                'Satellite (Esri)': satellite,
                'Esri Street': esriStreet,
                'CartoDB Positron': positron,
                'CartoDB Dark Matter': darkMatter,
                'CartoDB Voyager': voyager,
                'USGS Topo': usgsTopo,
                'USGS Imagery': usgsImagery
            }).addTo(map);

            function buildPopupHTML(photo) {
                var html = '<div class="photo-popup">';
                var imgTag = '<img src="' + photo.thumbnail + '" alt="' + (photo.caption || 'Photo') + '">';
                html += imgTag;
                if (photo.google_photos_url) {
                    html += '<a href="' + photo.google_photos_url + '" target="_blank" rel="noopener noreferrer" class="photo-link">View on Google Photos</a>';
                }
                html += '<div class="popup-info">';
                if (photo.caption) {
                    html += '<p class="popup-caption">' + photo.caption + '</p>';
                }
                if (photo.date) {
                    html += '<p class="popup-date">' + photo.date + '</p>';
                }
                if (photo.tags && photo.tags.length > 0) {
                    html += '<div class="popup-tags">';
                    for (var i = 0; i < photo.tags.length; i++) {
                        html += '<span class="popup-tag">' + photo.tags[i] + '</span>';
                    }
                    html += '</div>';
                }
                html += '</div></div>';
                return html;
            }

            function showEmptyState() {
                var el = document.createElement('div');
                el.className = 'empty-state';
                el.innerHTML = '<h2>No Photos Yet</h2><p>Add geotagged photos to the <code>photos/</code> folder<br>and run <code>python scripts/process_photos.py</code></p>';
                document.body.appendChild(el);
            }

            // Hoisted state for slider rebuilds
            var photoLayer = null;
            var allPhotos = [];
            var currentClusterRadius = 30;
            var currentIconSize = 60;

            function onPhotoClick(e) {
                var photo = e.layer.photo;
                L.popup({
                    className: 'leaflet-popup-photo',
                    maxWidth: 320,
                    minWidth: 200
                })
                .setLatLng(e.latlng)
                .setContent(buildPopupHTML(photo))
                .openOn(map);
            }

            function rebuildPhotoLayer() {
                if (photoLayer) {
                    photoLayer.off('click', onPhotoClick);
                    map.removeLayer(photoLayer);
                }
                photoLayer = L.photo.cluster({
                    maxClusterRadius: currentClusterRadius,
                    spiderfyDistanceMultiplier: 2,
                    iconSize: [currentIconSize, currentIconSize]
                });
                photoLayer.on('click', onPhotoClick);
                photoLayer.add(allPhotos).addTo(map);
            }

            // Slider control
            var SliderControl = L.Control.extend({
                options: { position: 'bottomleft' },
                onAdd: function () {
                    var container = L.DomUtil.create('div', 'slider-control');
                    L.DomEvent.disableClickPropagation(container);
                    L.DomEvent.disableScrollPropagation(container);

                    container.innerHTML =
                        '<label>Cluster Radius <span class="slider-value" id="cluster-val">' + currentClusterRadius + '</span></label>' +
                        '<input type="range" id="cluster-slider" min="10" max="100" value="' + currentClusterRadius + '">' +
                        '<label>Photo Size <span class="slider-value" id="size-val">' + currentIconSize + 'px</span></label>' +
                        '<input type="range" id="size-slider" min="30" max="120" value="' + currentIconSize + '">';

                    return container;
                }
            });

            new SliderControl().addTo(map);

            document.getElementById('cluster-slider').addEventListener('input', function () {
                currentClusterRadius = parseInt(this.value, 10);
                document.getElementById('cluster-val').textContent = currentClusterRadius;
                if (allPhotos.length > 0) rebuildPhotoLayer();
            });

            document.getElementById('size-slider').addEventListener('input', function () {
                currentIconSize = parseInt(this.value, 10);
                document.getElementById('size-val').textContent = currentIconSize + 'px';
                if (allPhotos.length > 0) rebuildPhotoLayer();
            });

            // Load annotations (graceful failure if missing)
            fetch('data/annotations.json')
                .then(function (response) {
                    if (!response.ok) return [];
                    return response.json();
                })
                .then(function (annotations) {
                    if (!annotations || annotations.length === 0) return;
                    for (var i = 0; i < annotations.length; i++) {
                        var ann = annotations[i];
                        var icon = L.divIcon({
                            className: 'annotation-marker',
                            html: '<span class="annotation-pin">&#128204;</span>',
                            iconSize: [28, 28],
                            iconAnchor: [14, 28]
                        });
                        var marker = L.marker([ann.lat, ann.lng], { icon: icon });
                        var popupHTML = '<div class="annotation-popup">';
                        if (ann.title) popupHTML += '<strong>' + ann.title + '</strong>';
                        if (ann.date) popupHTML += '<br><span class="annotation-date">' + ann.date + '</span>';
                        if (ann.text) popupHTML += '<p>' + ann.text + '</p>';
                        popupHTML += '</div>';
                        marker.bindPopup(popupHTML);
                        marker.addTo(map);
                    }
                })
                .catch(function () {
                    // annotations.json missing is fine
                });

            fetch('data/manifest.json')
                .then(function (response) {
                    if (!response.ok) throw new Error('Failed to load manifest');
                    return response.json();
                })
                .then(function (photos) {
                    if (!photos || photos.length === 0) {
                        showEmptyState();
                        return;
                    }

                    allPhotos = photos;
                    rebuildPhotoLayer();

                    try {
                        map.fitBounds(photoLayer.getBounds(), { padding: [50, 50] });
                    } catch (e) {
                        // getBounds can fail if all markers are at the same point
                    }
                })
                .catch(function (err) {
                    console.error('Error loading photo manifest:', err);
                    showEmptyState();
                });
        })();
    </script>
</body>
</html>
